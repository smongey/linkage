"use strict";var app=angular.module("linkageApp",["ngCookies","ngResource","ngSanitize","ngRoute","firebase"]);app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/posts.html",controller:"PostsCtrl"}).when("/posts/:postId",{templateUrl:"views/showpost.html",controller:"PostViewCtrl"}).when("/register",{templateUrl:"views/register.html",controller:"AuthCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"AuthCtrl"}).when("/users/:username",{templateUrl:"views/profile.html",controller:"ProfileCtrl"}).otherwise({redirectTo:"/"})}]).constant("FIREBASE_URL","https://blistering-fire-467.firebaseio.com/"),app.controller("PostsCtrl",["$scope","Post",function(a,b){a.posts=b.all,a.post={url:"http://",title:""},a.submitPost=function(){b.create(a.post).then(function(){a.post={url:"http://",title:""}})},a.deletePost=function(a){b.delete(a)}}]),app.controller("PostViewCtrl",["$scope","$routeParams","Post",function(a,b,c){a.post=c.find(b.postId),a.addComment=function(){c.addComment(b.postId,a.comment),a.comment={}},a.removeComment=function(b,d){c.deleteComment(a.post,b,d)}}]),app.controller("NavCtrl",["$scope","$location","Post","Auth",function(a,b,c,d){a.post={url:"",title:""},a.submitPost=function(){c.create(a.post).then(function(){a.post={url:"http://",title:""}})},a.logout=function(){d.logout()}}]),app.controller("AuthCtrl",["$scope","$location","Auth","User",function(a,b,c,d){c.signedIn()&&b.path("/"),a.$on("$firebaseSimpleLogin:login",function(){b.path("/")}),a.login=function(){c.login(a.user).then(function(){b.path("/")},function(b){a.error=b.toString()})},a.register=function(){c.register(a.user).then(function(c){d.create(c,a.user.username),b.path("/")},function(b){a.error=b.toString()})}}]),app.controller("ProfileCtrl",["$scope","$routeParams","Post","User",function(a,b,c,d){function e(){a.posts={},angular.forEach(a.user.posts,function(b){a.posts[b]=c.find(b)})}function f(){a.comments={},angular.forEach(a.user.comments,function(b){var d=c.find(b.postId);d.$on("loaded",function(){a.comments[b.id]=d.$child("comments").$child(b.id),a.commentedPosts[b.postId]=d})})}a.user=d.findByUsername(b.username),a.commentedPosts={},a.user.$on("loaded",function(){e(),f()})}]),app.factory("Auth",["$firebaseSimpleLogin","FIREBASE_URL","$rootScope",function(a,b,c){var d=new Firebase(b),e=a(d),f={register:function(a){return e.$createUser(a.email,a.password)},signedIn:function(){return null!==e.user},login:function(a){return e.$login("password",a)},logout:function(){e.$logout()}};return c.signedIn=function(){return f.signedIn()},f}]),app.factory("Post",["$firebase","FIREBASE_URL","User",function(a,b,c){var d=new Firebase(b+"posts"),e=a(d),f={all:e,create:function(a){if(c.signedIn()){var b=c.getCurrent();return a.owner=b.username,e.$add(a).then(function(a){var c=a.name();return b.$child("posts").$child(c).$set(c),c})}},find:function(a){return e.$child(a)},"delete":function(a){if(c.signedIn()){var b=f.find(a);b.$on("loaded",function(){var d=c.findByUsername(b.owner);e.$remove(a).then(function(){d.$child("posts").$remove(a)})})}},addComment:function(a,b){if(c.signedIn()){var d=c.getCurrent();b.username=d.username,b.postId=a,e.$child(a).$child("comments").$add(b).then(function(b){d.$child("comments").$child(b.name()).$set({id:b.name(),postId:a})})}},deleteComment:function(a,b,d){if(c.signedIn()){var e=c.findByUsername(b.username);a.$child("comments").$remove(d).then(function(){e.$child("comments").$remove(d)})}}};return f}]),app.factory("User",["$firebase","$rootScope","FIREBASE_URL",function(a,b,c){function d(a){b.currentUser=g.findByUsername(a)}var e=new Firebase(c+"users"),f=a(e),g={create:function(a,b){f[b]={md5_hash:a.md5_hash,username:b,$priority:a.uid},f.$save(b).then(function(){d(b)})},findByUsername:function(a){return a?f.$child(a):void 0},getCurrent:function(){return b.currentUser},signedIn:function(){return void 0!==b.currentUser}};return b.$on("$firebaseSimpleLogin:login",function(b,c){var f=a(e.startAt(c.uid).endAt(c.uid));f.$on("loaded",function(){d(f.$getIndex()[0])})}),b.$on("$firebaseSimpleLogin:logout",function(){delete b.currentUser}),g}]),app.filter("hostnameFromUrl",function(){return function(a){var b=document.createElement("a");return b.href=a,b.hostname}}),app.filter("reverse",function(){function a(a){var b,c=[];if(a)if(angular.isArray(a))c=a;else if("object"==typeof a)for(b in a)a.hasOwnProperty(b)&&c.push(a[b]);return c}return function(b){return a(b).slice().reverse()}}),app.filter("nospace",function(){return function(a){return a?a.replace(/ /g,"").toLowerCase():""}}),app.directive("checkUsername",["User",function(a){var b=/^[^.$\[\]#\/\s]+$/;return{require:"ng-model",link:function(c,d,e,f){f.$parsers.unshift(function(c){return b.test(c)?0===a.findByUsername(c).$getIndex.length?(f.$setValidity("taken",!0),f.$setValidity("invalid",!0),c):(f.$setValidity("taken",!1),void f.$setValidity("invalid",!0)):void f.$setValidity("invalid",!1)})}}}]);